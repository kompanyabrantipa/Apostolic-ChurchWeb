<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Setup Test - Apostolic Church</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #005a87; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0; }
        .test-item { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007cba; }
        .test-item h4 { margin: 0 0 10px 0; color: #007cba; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        .code { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
        .installation-steps { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Backend Setup Test - Apostolic Church</h1>
        <p>This tool tests the Node.js/Express backend server setup and verifies all components are working correctly.</p>
        
        <div class="info">
            <strong>üéØ Test Scope:</strong>
            <ul>
                <li><strong>Server Health:</strong> Verify backend server is running and accessible</li>
                <li><strong>Database Connection:</strong> Test PostgreSQL database connectivity</li>
                <li><strong>API Endpoints:</strong> Verify all CRUD endpoints are functional</li>
                <li><strong>Authentication:</strong> Test JWT authentication system</li>
                <li><strong>Data Integration:</strong> Verify API returns data in localStorage-compatible format</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>üìã Installation Status Check</h2>
        <p>First, let's verify that all backend components are properly installed and configured.</p>
        
        <button class="button" onclick="checkInstallationStatus()">Check Installation Status</button>
        <div id="installationStatusResult" class="info">Click "Check Installation Status" to verify backend setup.</div>
    </div>

    <div class="container">
        <h2>üîß Server Health Test</h2>
        <p>Test if the backend server is running and responding to requests.</p>
        
        <button class="button" onclick="testServerHealth()">Test Server Health</button>
        <div id="serverHealthResult" class="info">Click "Test Server Health" to check if the backend server is running.</div>
    </div>

    <div class="container">
        <h2>üîê Authentication Test</h2>
        <p>Test the JWT authentication system with the default admin credentials.</p>
        
        <button class="button" onclick="testAuthentication()">Test Authentication</button>
        <div id="authTestResult" class="info">Click "Test Authentication" to verify login functionality.</div>
    </div>

    <div class="container">
        <h2>üìä API Endpoints Test</h2>
        <p>Test all CRUD operations for blogs, events, and sermons to ensure API compatibility.</p>
        
        <div class="test-grid">
            <div class="test-item">
                <h4>üìö Blogs API Test</h4>
                <button class="button" onclick="testBlogsAPI()">Test Blogs API</button>
                <div id="blogsAPIResult" class="info">Test blogs CRUD operations</div>
            </div>
            <div class="test-item">
                <h4>üìÖ Events API Test</h4>
                <button class="button" onclick="testEventsAPI()">Test Events API</button>
                <div id="eventsAPIResult" class="info">Test events CRUD operations</div>
            </div>
            <div class="test-item">
                <h4>üé§ Sermons API Test</h4>
                <button class="button" onclick="testSermonsAPI()">Test Sermons API</button>
                <div id="sermonsAPIResult" class="info">Test sermons CRUD operations</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üîÑ DataService Integration Test</h2>
        <p>Test the enhanced DataService with API integration and localStorage fallback.</p>
        
        <button class="button" onclick="testDataServiceIntegration()">Test DataService Integration</button>
        <div id="dataServiceResult" class="info">Click "Test DataService Integration" to verify API-localStorage compatibility.</div>
    </div>

    <div class="container">
        <h2>üìà Complete Backend Test</h2>
        <p>Run all tests in sequence to verify complete backend functionality.</p>
        
        <button class="button success" onclick="runCompleteBackendTest()">Run Complete Test</button>
        <div id="completeTestResult" class="info">Click "Run Complete Test" to execute all backend tests.</div>
    </div>

    <div class="container">
        <h2>üöÄ Installation Instructions</h2>
        <div class="installation-steps">
            <h4>If Backend is Not Set Up Yet:</h4>
            <ol>
                <li><strong>Install Prerequisites:</strong>
                    <ul>
                        <li>Node.js 18+ from <a href="https://nodejs.org/" target="_blank">nodejs.org</a></li>
                        <li>PostgreSQL 12+ from <a href="https://www.postgresql.org/download/" target="_blank">postgresql.org</a></li>
                    </ul>
                </li>
                <li><strong>Run Installation Script:</strong>
                    <ul>
                        <li>Windows: Double-click <span class="code">install-backend.bat</span></li>
                        <li>Mac/Linux: Run <span class="code">./install-backend.sh</span></li>
                    </ul>
                </li>
                <li><strong>Configure Database:</strong>
                    <ul>
                        <li>Create database: <span class="code">CREATE DATABASE apostolic_church;</span></li>
                        <li>Create user: <span class="code">CREATE USER apostolic_user WITH PASSWORD 'your_password';</span></li>
                        <li>Grant permissions: <span class="code">GRANT ALL PRIVILEGES ON DATABASE apostolic_church TO apostolic_user;</span></li>
                    </ul>
                </li>
                <li><strong>Setup Database Schema:</strong>
                    <ul>
                        <li>Run: <span class="code">cd server && npm run setup-db</span></li>
                    </ul>
                </li>
                <li><strong>Start Server:</strong>
                    <ul>
                        <li>Run: <span class="code">cd server && npm run dev</span></li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <div class="container">
        <h2>üìä Test Results Summary</h2>
        <div id="testSummary" class="info">Test results will appear here after running tests.</div>
    </div>

    <!-- Include the enhanced DataService for testing -->
    <script src="js/data-service-api.js"></script>

    <script>
        let testResults = {
            installation: null,
            serverHealth: null,
            authentication: null,
            blogsAPI: null,
            eventsAPI: null,
            sermonsAPI: null,
            dataService: null
        };

        let authToken = null;

        async function checkInstallationStatus() {
            const resultDiv = document.getElementById('installationStatusResult');
            resultDiv.className = 'info';
            resultDiv.innerHTML = 'üîç Checking installation status...';

            try {
                // Check if server is accessible
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();

                if (healthData.success) {
                    testResults.installation = 'success';
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `
                        <h4><span class="status-indicator status-success"></span>‚úÖ Backend Installation Status: READY</h4>
                        <ul>
                            <li><strong>Server:</strong> Running on port ${window.location.port || '3001'}</li>
                            <li><strong>Database:</strong> ${healthData.database === 'connected' ? '‚úÖ Connected' : '‚ùå Disconnected'}</li>
                            <li><strong>Version:</strong> ${healthData.version || 'Unknown'}</li>
                            <li><strong>Timestamp:</strong> ${new Date(healthData.timestamp).toLocaleString()}</li>
                        </ul>
                        <p><strong>üéâ Backend is properly installed and running!</strong></p>
                    `;
                } else {
                    throw new Error('Server health check failed');
                }

            } catch (error) {
                testResults.installation = 'error';
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-error"></span>‚ùå Backend Installation Status: NOT READY</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Possible Issues:</strong></p>
                    <ul>
                        <li>Backend server is not running (run <span class="code">cd server && npm run dev</span>)</li>
                        <li>Database is not connected (check PostgreSQL installation)</li>
                        <li>Dependencies not installed (run <span class="code">cd server && npm install</span>)</li>
                        <li>Configuration issues (check <span class="code">server/.env</span> file)</li>
                    </ul>
                    <p><strong>üí° Solution:</strong> Follow the installation instructions above</p>
                `;
            }

            updateTestSummary();
        }

        async function testServerHealth() {
            const resultDiv = document.getElementById('serverHealthResult');
            resultDiv.className = 'info';
            resultDiv.innerHTML = 'üîç Testing server health...';

            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                if (data.success) {
                    testResults.serverHealth = 'success';
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `
                        <h4><span class="status-indicator status-success"></span>‚úÖ Server Health: EXCELLENT</h4>
                        <ul>
                            <li><strong>Status:</strong> ${data.message}</li>
                            <li><strong>Database:</strong> ${data.database}</li>
                            <li><strong>Response Time:</strong> Fast</li>
                            <li><strong>Server Time:</strong> ${new Date(data.timestamp).toLocaleString()}</li>
                        </ul>
                        <p><strong>üöÄ Server is running perfectly!</strong></p>
                    `;
                } else {
                    throw new Error(data.message || 'Health check failed');
                }

            } catch (error) {
                testResults.serverHealth = 'error';
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-error"></span>‚ùå Server Health: FAILED</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>üí° Solution:</strong> Ensure the backend server is running on port 3001</p>
                `;
            }

            updateTestSummary();
        }

        async function testAuthentication() {
            const resultDiv = document.getElementById('authTestResult');
            resultDiv.className = 'info';
            resultDiv.innerHTML = 'üîç Testing authentication...';

            try {
                // Test login with default credentials
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const loginData = await loginResponse.json();

                if (loginData.success) {
                    authToken = loginData.token;

                    // Test token verification
                    const verifyResponse = await fetch('/api/auth/verify', {
                        credentials: 'include'
                    });
                    const verifyData = await verifyResponse.json();

                    if (verifyData.success) {
                        testResults.authentication = 'success';
                        resultDiv.className = 'success';
                        resultDiv.innerHTML = `
                            <h4><span class="status-indicator status-success"></span>‚úÖ Authentication: WORKING</h4>
                            <ul>
                                <li><strong>Login:</strong> ‚úÖ Successful</li>
                                <li><strong>Token:</strong> ‚úÖ Valid</li>
                                <li><strong>User:</strong> ${verifyData.user.username} (${verifyData.user.role})</li>
                                <li><strong>Session:</strong> ‚úÖ Active</li>
                            </ul>
                            <p><strong>üîê Authentication system is working perfectly!</strong></p>
                        `;
                    } else {
                        throw new Error('Token verification failed');
                    }
                } else {
                    throw new Error(loginData.message || 'Login failed');
                }

            } catch (error) {
                testResults.authentication = 'error';
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-error"></span>‚ùå Authentication: FAILED</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>üí° Possible Solutions:</strong></p>
                    <ul>
                        <li>Check admin credentials in <span class="code">server/.env</span></li>
                        <li>Ensure database is set up: <span class="code">npm run setup-db</span></li>
                        <li>Verify JWT_SECRET is configured</li>
                    </ul>
                `;
            }

            updateTestSummary();
        }

        async function testBlogsAPI() {
            await testContentAPI('blogs', 'blogsAPIResult', 'blogsAPI');
        }

        async function testEventsAPI() {
            await testContentAPI('events', 'eventsAPIResult', 'eventsAPI');
        }

        async function testSermonsAPI() {
            await testContentAPI('sermons', 'sermonsAPIResult', 'sermonsAPI');
        }

        async function testContentAPI(contentType, resultDivId, testKey) {
            const resultDiv = document.getElementById(resultDivId);
            resultDiv.className = 'info';
            resultDiv.innerHTML = `üîç Testing ${contentType} API...`;

            try {
                // Ensure we're authenticated
                if (!authToken) {
                    await testAuthentication();
                    if (!authToken) {
                        throw new Error('Authentication required for API testing');
                    }
                }

                const headers = {
                    'Content-Type': 'application/json',
                };

                // Test GET all
                const getAllResponse = await fetch(`/api/${contentType}`, {
                    credentials: 'include',
                    headers
                });
                const getAllData = await getAllResponse.json();

                if (!getAllData.success) {
                    throw new Error(`GET /${contentType} failed: ${getAllData.message}`);
                }

                // Test CREATE
                const testItem = {
                    title: `Test ${contentType.slice(0, -1)} - ${new Date().toLocaleTimeString()}`,
                    ...(contentType === 'blogs' && {
                        summary: 'Test blog summary',
                        content: '<p>Test blog content</p>',
                        status: 'draft'
                    }),
                    ...(contentType === 'events' && {
                        date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        location: 'Test Location',
                        description: '<p>Test event description</p>',
                        status: 'draft'
                    }),
                    ...(contentType === 'sermons' && {
                        speaker: 'Test Speaker',
                        date: new Date().toISOString(),
                        description: '<p>Test sermon description</p>',
                        status: 'draft'
                    })
                };

                const createResponse = await fetch(`/api/${contentType}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers,
                    body: JSON.stringify(testItem)
                });
                const createData = await createResponse.json();

                if (!createData.success) {
                    throw new Error(`CREATE ${contentType} failed: ${createData.message}`);
                }

                const createdItem = createData.data;

                // Test UPDATE
                const updateData = {
                    title: createdItem.title + ' (Updated)',
                    status: 'published'
                };

                const updateResponse = await fetch(`/api/${contentType}/${createdItem.id}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers,
                    body: JSON.stringify(updateData)
                });
                const updateResult = await updateResponse.json();

                if (!updateResult.success) {
                    throw new Error(`UPDATE ${contentType} failed: ${updateResult.message}`);
                }

                // Test DELETE
                const deleteResponse = await fetch(`/api/${contentType}/${createdItem.id}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers
                });
                const deleteResult = await deleteResponse.json();

                if (!deleteResult.success) {
                    throw new Error(`DELETE ${contentType} failed: ${deleteResult.message}`);
                }

                testResults[testKey] = 'success';
                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-success"></span>‚úÖ ${contentType.toUpperCase()} API: WORKING</h4>
                    <ul>
                        <li><strong>GET All:</strong> ‚úÖ ${getAllData.count} items retrieved</li>
                        <li><strong>CREATE:</strong> ‚úÖ Item created successfully</li>
                        <li><strong>UPDATE:</strong> ‚úÖ Item updated successfully</li>
                        <li><strong>DELETE:</strong> ‚úÖ Item deleted successfully</li>
                    </ul>
                    <p><strong>üéâ All CRUD operations working perfectly!</strong></p>
                `;

            } catch (error) {
                testResults[testKey] = 'error';
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-error"></span>‚ùå ${contentType.toUpperCase()} API: FAILED</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>üí° Solution:</strong> Check server logs and database connection</p>
                `;
            }

            updateTestSummary();
        }

        async function testDataServiceIntegration() {
            const resultDiv = document.getElementById('dataServiceResult');
            resultDiv.className = 'info';
            resultDiv.innerHTML = 'üîç Testing DataService integration...';

            try {
                // Test if enhanced DataService is loaded
                if (typeof DataService === 'undefined') {
                    throw new Error('DataService not loaded');
                }

                // Test API mode configuration
                const config = DataService.getConfig();
                
                // Test create operation
                const testBlog = await DataService.create('blogs', {
                    title: 'DataService Integration Test - ' + new Date().toLocaleTimeString(),
                    summary: 'Testing DataService API integration',
                    content: '<p>This blog tests the DataService API integration.</p>',
                    status: 'draft'
                });

                if (!testBlog || !testBlog.id) {
                    throw new Error('DataService create failed');
                }

                // Test getAll operation
                const allBlogs = await DataService.getAll('blogs');
                if (!Array.isArray(allBlogs)) {
                    throw new Error('DataService getAll failed');
                }

                // Test update operation
                const updatedBlog = await DataService.update('blogs', testBlog.id, {
                    title: testBlog.title + ' (Updated)',
                    status: 'published'
                });

                if (!updatedBlog) {
                    throw new Error('DataService update failed');
                }

                // Test delete operation
                const deleted = await DataService.delete('blogs', testBlog.id);
                if (!deleted) {
                    throw new Error('DataService delete failed');
                }

                testResults.dataService = 'success';
                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-success"></span>‚úÖ DataService Integration: WORKING</h4>
                    <ul>
                        <li><strong>API Mode:</strong> ${config.useApi ? '‚úÖ Enabled' : '‚ùå Disabled'}</li>
                        <li><strong>Fallback:</strong> ${config.fallbackToLocalStorage ? '‚úÖ Enabled' : '‚ùå Disabled'}</li>
                        <li><strong>CREATE:</strong> ‚úÖ Working</li>
                        <li><strong>READ:</strong> ‚úÖ Working</li>
                        <li><strong>UPDATE:</strong> ‚úÖ Working</li>
                        <li><strong>DELETE:</strong> ‚úÖ Working</li>
                        <li><strong>Sync Events:</strong> ${config.enableSync ? '‚úÖ Enabled' : '‚ùå Disabled'}</li>
                    </ul>
                    <p><strong>üéâ DataService is fully compatible with the API!</strong></p>
                `;

            } catch (error) {
                testResults.dataService = 'error';
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-error"></span>‚ùå DataService Integration: FAILED</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>üí° Solution:</strong> Ensure data-service-api.js is loaded and API is accessible</p>
                `;
            }

            updateTestSummary();
        }

        async function runCompleteBackendTest() {
            const resultDiv = document.getElementById('completeTestResult');
            resultDiv.className = 'info';
            resultDiv.innerHTML = 'üîç Running complete backend test suite...';

            try {
                // Run all tests in sequence
                await checkInstallationStatus();
                await testServerHealth();
                await testAuthentication();
                await testBlogsAPI();
                await testEventsAPI();
                await testSermonsAPI();
                await testDataServiceIntegration();

                // Check overall results
                const allTests = Object.values(testResults);
                const successCount = allTests.filter(result => result === 'success').length;
                const totalTests = allTests.length;

                if (successCount === totalTests) {
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `
                        <h4><span class="status-indicator status-success"></span>üéâ Complete Backend Test: ALL PASSED</h4>
                        <p><strong>Results:</strong> ${successCount}/${totalTests} tests passed</p>
                        <ul>
                            <li>‚úÖ Installation Status: Ready</li>
                            <li>‚úÖ Server Health: Excellent</li>
                            <li>‚úÖ Authentication: Working</li>
                            <li>‚úÖ Blogs API: Working</li>
                            <li>‚úÖ Events API: Working</li>
                            <li>‚úÖ Sermons API: Working</li>
                            <li>‚úÖ DataService Integration: Working</li>
                        </ul>
                        <p><strong>üöÄ Your backend is fully operational and ready for production!</strong></p>
                        <p><strong>Next Steps:</strong></p>
                        <ul>
                            <li>Update your frontend to use the enhanced DataService</li>
                            <li>Test dashboard and frontend functionality</li>
                            <li>Migrate your localStorage data to the database</li>
                        </ul>
                    `;
                } else {
                    resultDiv.className = 'warning';
                    resultDiv.innerHTML = `
                        <h4><span class="status-indicator status-warning"></span>‚ö†Ô∏è Complete Backend Test: PARTIAL SUCCESS</h4>
                        <p><strong>Results:</strong> ${successCount}/${totalTests} tests passed</p>
                        <p><strong>Failed Tests:</strong> ${Object.entries(testResults).filter(([key, value]) => value === 'error').map(([key]) => key).join(', ')}</p>
                        <p><strong>üí° Please review the individual test results above and fix any issues.</strong></p>
                    `;
                }

            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4><span class="status-indicator status-error"></span>‚ùå Complete Backend Test: FAILED</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }

            updateTestSummary();
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            const results = Object.entries(testResults).filter(([key, value]) => value !== null);
            
            if (results.length === 0) {
                summaryDiv.className = 'info';
                summaryDiv.innerHTML = '<p>No tests have been run yet. Click the test buttons above to begin.</p>';
                return;
            }

            const successCount = results.filter(([key, value]) => value === 'success').length;
            const errorCount = results.filter(([key, value]) => value === 'error').length;
            const totalCount = results.length;

            let summaryClass = 'info';
            let summaryIcon = 'üìä';
            
            if (errorCount === 0 && successCount > 0) {
                summaryClass = 'success';
                summaryIcon = '‚úÖ';
            } else if (errorCount > 0) {
                summaryClass = 'warning';
                summaryIcon = '‚ö†Ô∏è';
            }

            summaryDiv.className = summaryClass;
            summaryDiv.innerHTML = `
                <h4>${summaryIcon} Test Results Summary</h4>
                <p><strong>Overall Status:</strong> ${successCount}/${totalCount} tests passed</p>
                <ul>
                    ${results.map(([key, value]) => {
                        const icon = value === 'success' ? '‚úÖ' : '‚ùå';
                        const name = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                        return `<li>${icon} ${name}: ${value === 'success' ? 'PASSED' : 'FAILED'}</li>`;
                    }).join('')}
                </ul>
                ${errorCount === 0 && successCount === 7 ? 
                    '<p><strong>üéâ All systems operational! Your backend is ready for production.</strong></p>' : 
                    '<p><strong>üí° Please address any failed tests before proceeding.</strong></p>'
                }
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Backend Setup Test Tool loaded');
            updateTestSummary();
        });
    </script>
</body>
</html>
