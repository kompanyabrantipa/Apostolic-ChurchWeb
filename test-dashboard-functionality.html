<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard Functionality</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #005a87; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background: #d4edda; color: #155724; }
        .test-fail { background: #f8d7da; color: #721c24; }
        .links { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
        .code { background: #f8f9fa; padding: 5px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Test Dashboard Functionality</h1>
        <p>This tool tests that the admin dashboard is working properly after fixing the initialization issues.</p>
        
        <div class="info">
            <strong>What was fixed:</strong>
            <ul>
                <li>Removed duplicate DOMContentLoaded listeners</li>
                <li>Removed duplicate addSampleData functions</li>
                <li>Consolidated all initialization into single DOMContentLoaded listener</li>
                <li>Preserved clean frontend (no hardcoded content)</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>🧪 Dashboard Tests</h2>
        
        <div class="info">
            <h4>Test 1: Dashboard Initialization</h4>
            <p>Verify that dashboard loads and initializes properly.</p>
            <button class="button" onclick="testDashboardInit()">Test Dashboard Init</button>
            <div id="dashboardInitResult" class="info">Click "Test Dashboard Init" to verify initialization.</div>
        </div>

        <div class="info">
            <h4>Test 2: Data Loading</h4>
            <p>Test that dashboard can load and display content from localStorage.</p>
            <button class="button" onclick="testDataLoading()">Test Data Loading</button>
            <div id="dataLoadingResult" class="info">Click "Test Data Loading" to verify data display.</div>
        </div>

        <div class="info">
            <h4>Test 3: Content Creation</h4>
            <p>Test that dashboard can create new content and sync to frontend.</p>
            <button class="button success" onclick="testContentCreation()">Test Content Creation</button>
            <div id="contentCreationResult" class="info">Click "Test Content Creation" to verify content creation works.</div>
        </div>

        <div class="info">
            <h4>Test 4: Frontend Sync</h4>
            <p>Verify that content created in dashboard appears on frontend pages.</p>
            <button class="button" onclick="testFrontendSync()">Test Frontend Sync</button>
            <div id="frontendSyncResult" class="info">Click "Test Frontend Sync" to verify real-time sync.</div>
        </div>
    </div>

    <div class="container">
        <h2>🔗 Quick Access</h2>
        <div class="links">
            <a href="http://localhost:3000/dashboard" class="button" target="_blank">Open Dashboard</a>
            <a href="blog.html" class="button" target="_blank">Blog Page</a>
            <a href="events.html" class="button" target="_blank">Events Page</a>
            <a href="sermon-archive.html" class="button" target="_blank">Sermons Page</a>
        </div>
    </div>

    <div class="container">
        <h2>📊 Current Status</h2>
        <div id="currentStatus" class="info">Loading current status...</div>
        <button class="button" onclick="checkCurrentStatus()">Refresh Status</button>
    </div>

    <!-- Include required scripts -->
    <script src="js/data-service.js"></script>

    <script>
        function testDashboardInit() {
            try {
                // Test if key dashboard functions exist
                const requiredFunctions = [
                    'loadDashboardData',
                    'loadContentCounts', 
                    'loadRecentContent',
                    'initManagers'
                ];
                
                let missingFunctions = [];
                
                // Note: We can't directly test these functions since they're in admin.js
                // But we can test if DataService is available (which dashboard depends on)
                if (typeof DataService === 'undefined') {
                    missingFunctions.push('DataService');
                }
                
                if (missingFunctions.length > 0) {
                    throw new Error('Missing required functions: ' + missingFunctions.join(', '));
                }
                
                document.getElementById('dashboardInitResult').className = 'test-pass';
                document.getElementById('dashboardInitResult').innerHTML = `
                    <h4>✅ Dashboard Initialization Test PASSED</h4>
                    <p><strong>DataService is available:</strong> ✅</p>
                    <p><strong>Next steps:</strong></p>
                    <ol>
                        <li>Open the dashboard at <span class="code">http://localhost:3000/dashboard</span></li>
                        <li>Verify it loads without blank screen</li>
                        <li>Check that content tables are visible (even if empty)</li>
                        <li>Verify dashboard stats show counts (0 or actual numbers)</li>
                    </ol>
                `;
                
                console.log('✅ Dashboard initialization test passed');
            } catch (error) {
                document.getElementById('dashboardInitResult').className = 'test-fail';
                document.getElementById('dashboardInitResult').textContent = 'Dashboard init test failed: ' + error.message;
            }
        }

        function testDataLoading() {
            try {
                // Create some test data to see if dashboard can load it
                const testBlog = {
                    id: 'test-' + Date.now(),
                    title: 'Dashboard Test Blog',
                    summary: 'Testing dashboard data loading functionality',
                    content: '<p>This blog tests if the dashboard can load and display content from localStorage.</p>',
                    status: 'published',
                    createdAt: new Date().toISOString()
                };
                
                // Add to localStorage
                const blogs = JSON.parse(localStorage.getItem('blogs') || '[]');
                blogs.push(testBlog);
                localStorage.setItem('blogs', JSON.stringify(blogs));
                
                // Trigger sync event
                const syncData = {
                    contentType: 'blogs',
                    action: 'create',
                    timestamp: Date.now()
                };
                localStorage.setItem('lastSync', JSON.stringify(syncData));
                window.dispatchEvent(new CustomEvent('contentSync', { detail: syncData }));
                
                document.getElementById('dataLoadingResult').className = 'test-pass';
                document.getElementById('dataLoadingResult').innerHTML = `
                    <h4>✅ Data Loading Test PASSED</h4>
                    <p><strong>Test blog created:</strong> "${testBlog.title}"</p>
                    <p><strong>Manual verification required:</strong></p>
                    <ol>
                        <li>Open the dashboard</li>
                        <li>Check if the blog count increased</li>
                        <li>Check if the test blog appears in the blog posts table</li>
                        <li>Verify it shows in recent content section</li>
                    </ol>
                `;
                
                console.log('✅ Data loading test completed');
                checkCurrentStatus();
            } catch (error) {
                document.getElementById('dataLoadingResult').className = 'test-fail';
                document.getElementById('dataLoadingResult').textContent = 'Data loading test failed: ' + error.message;
            }
        }

        function testContentCreation() {
            try {
                // Test content creation using DataService
                if (typeof DataService !== 'undefined' && DataService.create) {
                    const testBlog = DataService.create('blogs', {
                        title: 'Dashboard Content Creation Test - ' + new Date().toLocaleTimeString(),
                        summary: 'Testing content creation from dashboard functionality',
                        content: '<p>This blog tests if the dashboard can create new content properly.</p>',
                        status: 'published'
                    });
                    
                    document.getElementById('contentCreationResult').className = 'test-pass';
                    document.getElementById('contentCreationResult').innerHTML = `
                        <h4>✅ Content Creation Test PASSED</h4>
                        <p><strong>Test blog created:</strong> "${testBlog.title}"</p>
                        <p><strong>Blog ID:</strong> ${testBlog.id}</p>
                        <p><strong>Manual verification:</strong></p>
                        <ol>
                            <li>Open the dashboard - should show the new blog in the table</li>
                            <li>Check blog count increased</li>
                            <li>Verify it appears in recent content</li>
                        </ol>
                    `;
                } else {
                    throw new Error('DataService not available for content creation');
                }
                
                console.log('✅ Content creation test completed');
                checkCurrentStatus();
            } catch (error) {
                document.getElementById('contentCreationResult').className = 'test-fail';
                document.getElementById('contentCreationResult').textContent = 'Content creation test failed: ' + error.message;
            }
        }

        function testFrontendSync() {
            try {
                // Create content and test if it syncs to frontend
                if (typeof DataService !== 'undefined' && DataService.create) {
                    const timestamp = new Date().toLocaleTimeString();
                    const testBlog = DataService.create('blogs', {
                        title: `Frontend Sync Test - ${timestamp}`,
                        summary: 'Testing real-time sync between dashboard and frontend',
                        content: '<p>If you can see this blog on the frontend pages immediately, the sync is working!</p>',
                        status: 'published'
                    });
                    
                    document.getElementById('frontendSyncResult').className = 'test-pass';
                    document.getElementById('frontendSyncResult').innerHTML = `
                        <h4>✅ Frontend Sync Test INITIATED</h4>
                        <p><strong>Test blog created:</strong> "${testBlog.title}"</p>
                        <p><strong>Manual verification required:</strong></p>
                        <ol>
                            <li>Keep <span class="code">blog.html</span> open in another tab</li>
                            <li>The new blog should appear immediately without refresh</li>
                            <li>Open dashboard - should show the blog in the table</li>
                            <li>Both should show the same content</li>
                        </ol>
                        <p><strong>✅ If blog appears on both = Sync working</strong></p>
                        <p><strong>❌ If only in dashboard = Sync broken</strong></p>
                    `;
                } else {
                    throw new Error('DataService not available for sync test');
                }
                
                console.log('✅ Frontend sync test initiated');
                checkCurrentStatus();
            } catch (error) {
                document.getElementById('frontendSyncResult').className = 'test-fail';
                document.getElementById('frontendSyncResult').textContent = 'Frontend sync test failed: ' + error.message;
            }
        }

        function checkCurrentStatus() {
            try {
                const blogs = JSON.parse(localStorage.getItem('blogs') || '[]');
                const events = JSON.parse(localStorage.getItem('events') || '[]');
                const sermons = JSON.parse(localStorage.getItem('sermons') || '[]');
                const lastSync = JSON.parse(localStorage.getItem('lastSync') || '{}');
                
                const publishedBlogs = blogs.filter(b => b.status === 'published');
                const draftBlogs = blogs.filter(b => b.status === 'draft');
                const publishedEvents = events.filter(e => e.status === 'published');
                const publishedSermons = sermons.filter(s => s.status === 'published');
                
                document.getElementById('currentStatus').className = 'info';
                document.getElementById('currentStatus').innerHTML = `
                    <h4>📊 Current System Status:</h4>
                    <p><strong>Total Content:</strong> ${blogs.length} blogs, ${events.length} events, ${sermons.length} sermons</p>
                    <p><strong>Published Content:</strong> ${publishedBlogs.length} blogs, ${publishedEvents.length} events, ${publishedSermons.length} sermons</p>
                    <p><strong>Draft Content:</strong> ${draftBlogs.length} blogs</p>
                    <p><strong>Last Sync:</strong> ${lastSync.timestamp ? new Date(lastSync.timestamp).toLocaleString() : 'Never'}</p>
                    
                    <h4>🎯 Expected Dashboard Display:</h4>
                    <ul>
                        <li><strong>Blog Count:</strong> ${blogs.length}</li>
                        <li><strong>Event Count:</strong> ${events.length}</li>
                        <li><strong>Sermon Count:</strong> ${sermons.length}</li>
                        <li><strong>Blog Table:</strong> Should show all ${blogs.length} blogs (published + draft)</li>
                        <li><strong>Recent Content:</strong> Should show latest items</li>
                    </ul>
                    
                    <h4>🎯 Expected Frontend Display:</h4>
                    <ul>
                        <li><strong>blog.html:</strong> ${publishedBlogs.length > 0 ? `${publishedBlogs.length} published blogs` : 'No blog posts available message'}</li>
                        <li><strong>events.html:</strong> ${publishedEvents.length > 0 ? `${publishedEvents.length} published events` : 'No upcoming events message'}</li>
                        <li><strong>sermon-archive.html:</strong> ${publishedSermons.length > 0 ? `${publishedSermons.length} published sermons` : 'No sermons available message'}</li>
                    </ul>
                `;
            } catch (error) {
                document.getElementById('currentStatus').className = 'error';
                document.getElementById('currentStatus').textContent = 'Error checking status: ' + error.message;
            }
        }

        // Listen for sync events
        window.addEventListener('contentSync', function(event) {
            console.log('🔄 Sync event detected:', event.detail);
            checkCurrentStatus();
        });

        window.addEventListener('storage', function(event) {
            if (['blogs', 'events', 'sermons', 'lastSync'].includes(event.key)) {
                console.log('💾 Storage change detected:', event.key);
                checkCurrentStatus();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkCurrentStatus();
            console.log('🔧 Dashboard Functionality Test Tool loaded.');
        });
    </script>
</body>
</html>
